-- checar se devemos mostrar apenas inimigos
if showOnlyEnemies and plr.Team == player.Team then return end

-- esperar pelo character e HumanoidRootPart (com timeout simples)
local char = plr.Character or plr.CharacterAdded:Wait()
if not char then return end
local root = char:FindFirstChild("HumanoidRootPart")
-- se ainda não existir, aguardar por até 5 segundos
if not root then
	local waited = 0
	while waited < 5 and not root do
		wait(0.1)
		waited = waited + 0.1
		root = char:FindFirstChild("HumanoidRootPart")
	end
	if not root then return end
end

-- criar BillboardGui
local billboard = Instance.new("BillboardGui")
billboard.Name = "ESPLabel"
billboard.Adornee = root
billboard.Size = UDim2.new(0,140,0,36)
billboard.StudsOffset = Vector3.new(0,2.5,0)
billboard.AlwaysOnTop = true
billboard.Parent = playerGui -- colocamos no PlayerGui (funciona bem com Adornee)

local nameLabel = Instance.new("TextLabel")
nameLabel.Name = "NameLabel"
nameLabel.Size = UDim2.new(1,0,1,0)
nameLabel.Position = UDim2.new(0,0,0,0)
nameLabel.BackgroundTransparency = 1
nameLabel.Text = plr.Name
nameLabel.TextScaled = true
nameLabel.Font = Enum.Font.SourceSansBold
nameLabel.TextColor3 = safeTeamColor(plr)
nameLabel.TextStrokeTransparency = 0.4
nameLabel.Parent = billboard

playerLabels[plr] = { gui = billboard }

-- conectar para atualizar adornee quando o personagem renascer
local charAddedConn
charAddedConn = plr.CharacterAdded:Connect(function(newChar)
	-- aguardar HRP
	local newRoot = newChar:WaitForChild("HumanoidRootPart", 5)
	if playerLabels[plr] and playerLabels[plr].gui then
		playerLabels[plr].gui.Adornee = newRoot
	end
end)

-- opcional: remover gui quando o Character for removido (para evitar adornee nulo permanente)
local charRemovingConn
if char then
	charRemovingConn = char:FindFirstChildWhichIsA("HumanoidRootPart") and nil or nil
end
-- armazenar conexões para desconectar depois
playerLabels[plr].charConn = charAddedConn
playerLabels[plr].removeConn = charRemovingConn
