-- LocalScript: ESP simples com nome e cor do time
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local playerESPMap = {}

-- Função pra pegar a cor do time
local function getPlayerColor(p)
    if p.Team and p.Team.TeamColor then
        return p.Team.TeamColor.Color
    end
    return Color3.fromRGB(255,255,255) -- fallback branco
end

-- Criar ESP para um player
local function createESPFor(p)
    if playerESPMap[p] then return end
    if not p.Character then return end
    local head = p.Character:FindFirstChild("Head")
    if not head then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Adornee = head
    billboard.Size = UDim2.new(0,100,0,10)
    billboard.StudsOffset = Vector3.new(0,2.5,0)
    billboard.AlwaysOnTop = true
    billboard.Parent = playerGui

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1,0,1,0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = p.Name
    textLabel.TextColor3 = getPlayerColor(p)
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 10
    textLabel.TextStrokeTransparency = 0.6
    textLabel.Parent = billboard

    playerESPMap[p] = billboard

    -- Remove ESP quando personagem for removido
    p.CharacterRemoving:Connect(function()
        if playerESPMap[p] then
            pcall(function() playerESPMap[p]:Destroy() end)
            playerESPMap[p] = nil
        end
    end)
end

-- Remover ESP de player
local function removeESPFor(p)
    if playerESPMap[p] then
        pcall(function() playerESPMap[p]:Destroy() end)
        playerESPMap[p] = nil
    end
end

-- Atualizar ESP de todos os players
local function refreshESP()
    for _,p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            createESPFor(p)
            -- atualiza a cor do nome caso mude de time
            local label = playerESPMap[p] and playerESPMap[p]:FindFirstChildOfClass("TextLabel")
            if label then
                label.TextColor3 = getPlayerColor(p)
            end
        end
    end
    -- limpa ESP de players que saíram
    for p,_ in pairs(playerESPMap) do
        if not p.Parent or not p.Character then
            removeESPFor(p)
        end
    end
end

-- Atualiza sempre
RunService.Heartbeat:Connect(refreshESP)

-- Criar ESP ao entrar no servidor
Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function()
        refreshESP()
    end)
end)

-- Remove ESP quando player sai
Players.PlayerRemoving:Connect(removeESPFor)
