-- LocalScript: Painel de Testes com ESP, TeamCheck, Infinite Jump e nomes
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local camera = workspace.CurrentCamera

local connections = {}
local espMap = {} -- [player] = {highlight, nameLabel}
local infiniteJumpEnabled = false
local menuOpen = true

-- ===== Funções ESP =====
local function createESPFor(p)
    if espMap[p] then return end
    local char = p.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    -- Highlight
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESP_"..p.Name
    highlight.Adornee = char
    highlight.FillTransparency = 0.6
    highlight.OutlineTransparency = 0.3
    highlight.Parent = playerGui

    -- Cor do time
    if p.Team and p.Team.TeamColor then
        highlight.FillColor = p.Team.TeamColor.Color
        highlight.OutlineColor = p.Team.TeamColor.Color
    else
        highlight.FillColor = Color3.fromRGB(255,0,0)
        highlight.OutlineColor = Color3.fromRGB(255,0,0)
    end

    -- Nome acima da cabeça
    local nameLabel = Instance.new("BillboardGui")
    nameLabel.Name = "ESPName_"..p.Name
    nameLabel.Adornee = char:FindFirstChild("Head") or root
    nameLabel.Size = UDim2.new(0, 100, 0, 20)
    nameLabel.StudsOffset = Vector3.new(0, 2.5, 0)
    nameLabel.AlwaysOnTop = true
    nameLabel.Parent = playerGui

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1,0,1,0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = p.Name
    textLabel.TextColor3 = highlight.FillColor
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 14
    textLabel.TextScaled = false
    textLabel.TextStrokeTransparency = 0.6
    textLabel.Parent = nameLabel

    espMap[p] = {highlight=highlight, nameLabel=nameLabel}
end

local function removeESPFor(p)
    local data = espMap[p]
    if data then
        pcall(function()
            if data.highlight then data.highlight:Destroy() end
            if data.nameLabel then data.nameLabel:Destroy() end
        end)
        espMap[p] = nil
    end
end

local function refreshESP()
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player then createESPFor(p) end
    end
    for p, _ in pairs(espMap) do
        if not p.Parent then removeESPFor(p) end
    end
end

-- Atualiza automaticamente quando jogadores entram, saem ou respawnam
table.insert(connections, Players.PlayerAdded:Connect(function(p)
    createESPFor(p)
    table.insert(connections, p.CharacterAdded:Connect(function()
        removeESPFor(p)
        createESPFor(p)
    end))
end))
table.insert(connections, Players.PlayerRemoving:Connect(removeESPFor))

refreshESP()

-- ===== UI =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DebugCustomUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 420, 0, 220)
mainFrame.Position = UDim2.new(0.5, -210, 0.5, -110)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(35,35,35)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,8)

-- Título
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -16, 0, 28)
title.Position = UDim2.new(0, 8, 0, 8)
title.BackgroundTransparency = 1
title.Text = "Painel de Testes"
title.TextColor3 = Color3.fromRGB(240,240,240)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = mainFrame

-- Botões
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0,36,0,24)
closeBtn.Position = UDim2.new(1, -44, 0, 8)
closeBtn.BackgroundColor3 = Color3.fromRGB(200,60,60)
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.new(1,1,1)
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 18
closeBtn.Parent = mainFrame
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0,6)

local dragBtn = Instance.new("TextButton")
dragBtn.Size = UDim2.new(0,28,0,28)
dragBtn.Position = UDim2.new(1, -80, 0, 8)
dragBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
dragBtn.Text = "⇅"
dragBtn.TextColor3 = Color3.new(1,1,1)
dragBtn.Font = Enum.Font.SourceSansBold
dragBtn.TextSize = 18
dragBtn.Parent = mainFrame
Instance.new("UICorner", dragBtn).CornerRadius = UDim.new(0,6)

local refreshBtn = Instance.new("TextButton")
refreshBtn.Size = UDim2.new(0, 100, 0, 28)
refreshBtn.Position = UDim2.new(0, 12, 0, 48)
refreshBtn.BackgroundColor3 = Color3.fromRGB(80,80,200)
refreshBtn.Text = "Refresh ESP"
refreshBtn.TextColor3 = Color3.new(1,1,1)
refreshBtn.Font = Enum.Font.SourceSansBold
refreshBtn.TextSize = 14
refreshBtn.Parent = mainFrame
Instance.new("UICorner", refreshBtn).CornerRadius = UDim.new(0,6)
table.insert(connections, refreshBtn.MouseButton1Click:Connect(refreshESP))

local ijToggle = Instance.new("TextButton")
ijToggle.Size = UDim2.new(0, 120, 0, 28)
ijToggle.Position = UDim2.new(0,12,0,88)
ijToggle.BackgroundColor3 = Color3.fromRGB(90,90,90)
ijToggle.Text = "Infinite Jump: Off"
ijToggle.TextColor3 = Color3.fromRGB(240,240,240)
ijToggle.Font = Enum.Font.SourceSansBold
ijToggle.TextSize = 14
ijToggle.Parent = mainFrame
Instance.new("UICorner", ijToggle).CornerRadius = UDim.new(0,6)

table.insert(connections, ijToggle.MouseButton1Click:Connect(function()
    infiniteJumpEnabled = not infiniteJumpEnabled
    ijToggle.Text = "Infinite Jump: "..(infiniteJumpEnabled and "On" or "Off")
    ijToggle.BackgroundColor3 = infiniteJumpEnabled and Color3.fromRGB(80,160,80) or Color3.fromRGB(90,90,90)
end))

table.insert(connections, UserInputService.JumpRequest:Connect(function()
    if not infiniteJumpEnabled then return end
    local char = player.Character
    if char then
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid and humanoid.Health > 0 then
            pcall(function() humanoid:ChangeState(Enum.HumanoidStateType.Jumping) end)
        end
    end
end))

-- ===== Drag =====
local draggingMenu = false
local dragOffset = Vector2.new(0,0)
dragBtn.MouseButton1Down:Connect(function(input)
    draggingMenu = true
    dragOffset = Vector2.new(input.Position.X - mainFrame.AbsolutePosition.X, input.Position.Y - mainFrame.AbsolutePosition.Y)
end)
UserInputService.InputChanged:Connect(function(input)
    if draggingMenu and input.UserInputType == Enum.UserInputType.MouseMovement then
        mainFrame.Position = UDim2.new(0, input.Position.X - dragOffset.X, 0, input.Position.Y - dragOffset.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingMenu = false
    end
end)

-- ===== Minimizar / Abrir com M =====
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.M then
        menuOpen = not menuOpen
        mainFrame.Visible = menuOpen
    end
end)

-- ===== Close / Cleanup =====
local function cleanup()
    for _, con in ipairs(connections) do
        if con and typeof(con) == "RBXScriptConnection" then
            pcall(function() con:Disconnect() end)
        end
    end
    connections = {}
    for p, _ in pairs(espMap) do
        removeESPFor(p)
    end
    pcall(function() screenGui:Destroy() end)
end
closeBtn.MouseButton1Click:Connect(cleanup)

print("[DebugCustomUI] Script carregado com ESP colorido por time, nome e Infinite Jump.")
