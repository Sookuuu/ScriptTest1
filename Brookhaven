-- Hub BR - Rayfield + ESP / Teleport / Spectate / TP-BUG LOOP + TP Normal + Invis√≠vel
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Mec BR - FREEHUB V4 (ESP+TP+VIEW+BUG LOOP+TP+INVIS)",
   LoadingTitle = "Carregando Menu",
   LoadingSubtitle = "by OfficialPatozoid - Modificado",
   ShowText = "Rayfield",
   Theme = "Default",
   ToggleUIKeybind = "K",
   ConfigurationSaving = { Enabled = true, FolderName = nil, FileName = "Big Hub" },
})

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- === Configs iniciais ===
local MAX_SPEED = 3000
local MAX_JUMP = 3000
local MAX_FLY = 3000

-- Tabs
local PlayerTab = Window:CreateTab("Player", 4483362458)
local TPTab = Window:CreateTab("üßøTeleports", 4483362458)
local VeiculoTab = Window:CreateTab("üöóVeiculos", 4483362458)
local CreditsTab = Window:CreateTab("Credits", 4483362458)

-- Creditos
CreditsTab:CreateLabel("HUB BY: OfficialPatozoid (mod)", 4483362458, Color3.fromRGB(255,255,255), false)

-- Utilities
local function safeFindChar(p)
    return p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character
end

-- ====== ESP ======
local espEnabled = false
local espMap = {}

local function makeBillboardForCharacter(plr)
    if not plr or not plr.Character then return end
    local char = plr.Character
    local head = char:FindFirstChild("Head") or char:FindFirstChild("HumanoidRootPart")
    if not head then return end
    if espMap[plr] and espMap[plr].Parent then return espMap[plr] end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "MecBR_ESP"
    billboard.Adornee = head
    billboard.AlwaysOnTop = true
    billboard.Size = UDim2.new(0, 120, 0, 28)
    billboard.StudsOffset = Vector3.new(0, 2.4, 0)
    billboard.Parent = head

    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.new(1, 0, 1, 0)
    txt.BackgroundTransparency = 1
    txt.Text = plr.Name
    txt.Font = Enum.Font.GothamSemibold
    txt.TextSize = 16
    txt.TextStrokeTransparency = 0.6
    txt.TextScaled = false
    txt.Parent = billboard

    espMap[plr] = billboard
    return billboard
end

local function removeESP(plr)
    if espMap[plr] then
        pcall(function() espMap[plr]:Destroy() end)
        espMap[plr] = nil
    end
end

local function refreshAllESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        removeESP(plr)
        if espEnabled and plr ~= player then
            makeBillboardForCharacter(plr)
        end
    end
end

Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function()
        if espEnabled and plr ~= player then
            task.wait(0.05)
            makeBillboardForCharacter(plr)
        end
    end)
end)
Players.PlayerRemoving:Connect(function(plr)
    removeESP(plr)
end)

local ESPToggle = PlayerTab:CreateToggle({
    Name = "ESP Players (nomes)",
    CurrentValue = false,
    Flag = "ESPPlayersToggle",
    Callback = function(val)
        espEnabled = val
        if espEnabled then
            for _, plr in ipairs(Players:GetPlayers()) do
                if plr ~= player then
                    makeBillboardForCharacter(plr)
                end
            end
        else
            for k,_ in pairs(espMap) do removeESP(k) end
        end
    end,
})

-- ====== Player Controls ======
local humanoid = nil
local character = player.Character or player.CharacterAdded:Wait()

local function onCharacter(char)
    character = char
    humanoid = char:FindFirstChildOfClass("Humanoid")
end
player.CharacterAdded:Connect(onCharacter)
if player.Character then onCharacter(player.Character) end

-- WalkSpeed
local WalkSlider = PlayerTab:CreateSlider({
    Name = "WalkSpeed",
    Range = {0, MAX_SPEED},
    Increment = 1,
    Suffix = "WS",
    CurrentValue = 16,
    Flag = "WalkSpeedSlider",
    Callback = function(value)
        if humanoid then
            pcall(function() humanoid.WalkSpeed = value end)
        end
    end,
})

-- JumpPower
local currentJumpPower = 50
local JumpSlider = PlayerTab:CreateSlider({
    Name = "JumpPower",
    Range = {0, MAX_JUMP},
    Increment = 1,
    Suffix = "JP",
    CurrentValue = currentJumpPower,
    Flag = "JumpPowerSlider",
    Callback = function(value)
        currentJumpPower = value
        if humanoid and humanoid.Parent then
            pcall(function() humanoid.JumpPower = currentJumpPower end)
        end
    end,
})

-- Infinite Jump
local infiniteJump = false
PlayerTab:CreateToggle({
    Name = "Infinite Jump",
    CurrentValue = false,
    Flag = "InfiniteJumpToggle",
    Callback = function(v) infiniteJump = v end,
})
UserInputService.JumpRequest:Connect(function()
    if infiniteJump and humanoid then
        pcall(function() humanoid:ChangeState(Enum.HumanoidStateType.Jumping) end)
    end
end)

-- Noclip
local noclip = false
PlayerTab:CreateToggle({
    Name = "Noclip",
    CurrentValue = false,
    Flag = "NoclipToggle",
    Callback = function(v) noclip = v end,
})
RunService.Stepped:Connect(function()
    if not character then return end
    for _, part in ipairs(character:GetChildren()) do
        if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
            part.CanCollide = (not noclip)
        end
    end
end)

-- Fly
local flying = false
local flySpeed = 50
local keys = {W=false,A=false,S=false,D=false,Space=false,LeftShift=false}

PlayerTab:CreateToggle({
    Name = "Fly",
    CurrentValue = false,
    Flag = "FlyToggle",
    Callback = function(v)
        flying = v
        if not flying and character and character:FindFirstChild("HumanoidRootPart") then
            character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
        end
    end,
})

local FlySlider = PlayerTab:CreateSlider({
    Name = "Fly Speed",
    Range = {10, MAX_FLY},
    Increment = 5,
    Suffix = "Studs/s",
    CurrentValue = flySpeed,
    Flag = "FlySpeedSlider",
    Callback = function(v) flySpeed = v end,
})

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.W then keys.W = true end
    if input.KeyCode == Enum.KeyCode.A then keys.A = true end
    if input.KeyCode == Enum.KeyCode.S then keys.S = true end
    if input.KeyCode == Enum.KeyCode.D then keys.D = true end
    if input.KeyCode == Enum.KeyCode.Space then keys.Space = true end
    if input.KeyCode == Enum.KeyCode.LeftShift then keys.LeftShift = true end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.W then keys.W = false end
    if input.KeyCode == Enum.KeyCode.A then keys.A = false end
    if input.KeyCode == Enum.KeyCode.S then keys.S = false end
    if input.KeyCode == Enum.KeyCode.D then keys.D = false end
    if input.KeyCode == Enum.KeyCode.Space then keys.Space = false end
    if input.KeyCode == Enum.KeyCode.LeftShift then keys.LeftShift = false end
end)

RunService.RenderStepped:Connect(function()
    if flying and character and character:FindFirstChild("HumanoidRootPart") then
        local hrp = character.HumanoidRootPart
        local dir = Vector3.new(0,0,0)
        local cam = workspace.CurrentCamera
        if keys.W then dir = dir + cam.CFrame.LookVector end
        if keys.S then dir = dir - cam.CFrame.LookVector end
        if keys.A then dir = dir - cam.CFrame.RightVector end
        if keys.D then dir = dir + cam.CFrame.RightVector end
        if keys.Space then dir = dir + Vector3.new(0,1,0) end
        if keys.LeftShift then dir = dir - Vector3.new(0,1,0) end

        if dir.Magnitude > 0 then
            hrp.Velocity = dir.Unit * flySpeed
        else
            hrp.Velocity = Vector3.new(0,0,0)
        end
    end
end)

-- ====== Teleport + BUG LOOP ======
local targetName = ""
local function getPlayerByNameOrPrefix(name)
    if not name or name == "" then return nil end
    name = name:lower()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr.Name:lower():sub(1, #name) == name then
            return plr
        end
    end
    return nil
end

local NameBox = TPTab:CreateInput({
    Name = "Nome do Player (prefixo ok)",
    PlaceholderText = "Ex: Canario",
    RemoveTextAfterFocusLost = false,
    Callback = function(text) targetName = text end,
})

local tpBugLoop = false
local bugDistance = 20000

TPTab:CreateToggle({
    Name = "TP + BUG LOOP",
    CurrentValue = false,
    Flag = "TPBugLoopToggle",
    Callback = function(val)
        tpBugLoop = val
    end,
})

task.spawn(function()
    while true do
        task.wait(1)
        if tpBugLoop then
            local target = getPlayerByNameOrPrefix(targetName)
            if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    pcall(function()
                        player.Character.HumanoidRootPart.CFrame = target.Character.HumanoidRootPart.CFrame + Vector3.new(0,5,0)
                        player.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
                    end)
                end
                pcall(function()
                    target.Character.HumanoidRootPart.CFrame = CFrame.new(Vector3.new(bugDistance,500,bugDistance))
                    target.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
                end)
                StarterGui:SetCore("SendNotification",{
                    Title = "TP+BUG",
                    Text = "Voc√™ -> "..target.Name.." | "..target.Name.." bugado!",
                    Duration = 2
                })
            end
        end
    end
end)

-- ====== Teleport Normal ======
TPTab:CreateButton({
    Name = "Teleport Normal ao Player",
    Callback = function()
        local target = getPlayerByNameOrPrefix(targetName)
        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                pcall(function()
                    player.Character.HumanoidRootPart.CFrame = target.Character.HumanoidRootPart.CFrame + Vector3.new(0,5,0)
                    player.Character.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
                end)
                StarterGui:SetCore("SendNotification",{
                    Title = "Teleport",
                    Text = "Teleportado at√© "..target.Name,
                    Duration = 2
                })
            end
        else
            StarterGui:SetCore("SendNotification",{
                Title = "Teleport",
                Text = "Target inv√°lido!",
                Duration = 2
            })
        end
    end
})

-- ====== Toggle Invisibilidade ======
local invisible = false
PlayerTab:CreateToggle({
    Name = "Invis√≠vel",
    CurrentValue = false,
    Flag = "InvisibleToggle",
    Callback = function(val)
        invisible = val
        if character then
            for _, part in ipairs(character:GetChildren()) do
                if part:IsA("BasePart") or part:IsA("Decal") or part:IsA("MeshPart") then
                    part.Transparency = invisible and 1 or 0
                    if part:IsA("BasePart") then
                        part.CanCollide = not invisible
                    end
                elseif part:IsA("Accessory") then
                    local handle = part:FindFirstChild("Handle")
                    if handle then
                        handle.Transparency = invisible and 1 or 0
                    end
                end
            end
            if humanoid then
                humanoid.NameDisplayDistance = invisible and 0 or 100
            end
        end
    end
})

-- Spectate
local isSpectating = false
local spectateTarget = nil
local oldCameraSubject = nil

TPTab:CreateToggle({
    Name = "Ver Player (Spectate)",
    CurrentValue = false,
    Flag = "SpectateToggle",
    Callback = function(val)
        if val then
            local target = getPlayerByNameOrPrefix(targetName)
            if not target or not target.Character or not target.Character:FindFirstChildOfClass("Humanoid") then
                StarterGui:SetCore("SendNotification",{Title="Spectate",Text="Target inv√°lido.",Duration=3})
                return
            end
            spectateTarget = target
            oldCameraSubject = workspace.CurrentCamera.CameraSubject
            workspace.CurrentCamera.CameraSubject = target.Character:FindFirstChildOfClass("Humanoid")
            isSpectating = true
            StarterGui:SetCore("SendNotification",{Title="Spectate",Text="Agora vendo: "..target.Name,Duration=3})
        else
            if oldCameraSubject then
                workspace.CurrentCamera.CameraSubject = oldCameraSubject
            elseif player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
                workspace.CurrentCamera.CameraSubject = player.Character:FindFirstChildOfClass("Humanoid")
            end
            isSpectating = false
            spectateTarget = nil
            StarterGui:SetCore("SendNotification",{Title="Spectate",Text="Parou de ver.",Duration=2})
        end
    end,
})

-- Refresh ESP/Players
TPTab:CreateButton({
    Name = "Refresh ESP/Players",
    Callback = function()
        refreshAllESP()
        StarterGui:SetCore("SendNotification",{Title="Refresh",Text="ESP/Players refreshed",Duration=2})
    end
})

-- Veiculos Tab
VeiculoTab:CreateLabel("Car Notifier inertial (mantive fun√ß√µes originais)", 4483362458, Color3.fromRGB(255,255,255), false)

-- Aplicar JumpPower inicial
task.defer(function()
    if humanoid then
        pcall(function() humanoid.JumpPower = currentJumpPower end
